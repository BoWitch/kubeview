<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>KubeView</title>

  <script src="js/cytoscape.min.js"></script>

  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div id="mainview"></div>

<script>
var cy = cytoscape({
  container: document.getElementById('mainview'),
  wheelSensitivity:0.1
});

fetch('http://localhost:3000/api/scrape/default')
.then(response => response.json())
.then(json => {
  for(let rs of json.replicasets) {
    console.log("RS", rs.metadata.name)

    let colour = 'green'
    if(rs.status.replicas != rs.status.readyReplicas) colour = 'red'

    cy.add({
      data: {
        id: rs.metadata.uid,
        label: rs.metadata.name,
        img: `img/svg/unlabeled/rs-${colour}.svg`
      }
    })
  }

  for(let pod of json.pods) {
    console.log("POD", pod.metadata.name)

    let colour = 'green'
    if(pod.status.phase == 'Pending') colour = 'grey'
    if(pod.status.phase == 'Failed' || pod.status.phase == 'Unknown' || pod.status.phase == 'CrashLoopBackOff') colour = 'red'
    cy.add({
      data: {
        id: pod.metadata.uid,
        label: pod.metadata.name,
        img: `img/svg/unlabeled/pod-${colour}.svg`
      }
    })
    
  //   for(let container of pod.spec.containers) {
  //     console.log("CONTAINER", container.name);
      
  //     let containerId = pod.metadata.uid + '_' + container.name

  //     cy.add({
  //       data: {
  //         id: containerId,
  //         label: container.name,
  //         img: 'img/container.png'
  //       }
  //     })      
    
  //     cy.add({
  //       data: {
  //         id: containerId + '-link-cont', source: pod.metadata.uid, target: containerId
  //       }
  //     })
  //   }

    for(let ownerRef of pod.metadata.ownerReferences) {
      if(ownerRef.kind != "ReplicaSet") continue
    
      cy.add({
        data: {
          id: pod.metadata.uid + '-link-rs', source: pod.metadata.uid, target: ownerRef.uid
        }
      })
    }    
  }

  for(let ep of json.endpoints) {
    console.log("EP", ep.metadata.name)
    
    // Skip kubernetes service
    if(ep.metadata.name == 'kubernetes') continue
    if(!ep.subsets) continue

    cy.add({
      data: {
        id: ep.metadata.name,
        label: ep.metadata.name,
        img: 'img/svg/unlabeled/svc.svg'
      }
    })
    
    for(let subset of ep.subsets) {
      for(let address of subset.addresses) {
        if(!address.targetRef) continue
        if(address.targetRef.kind != "Pod") continue
        cy.add({
          data: {
            id: ep.metadata.uid + '-link-ep-'+address.ip, source: ep.metadata.name, target: address.targetRef.uid
          }
        })
      }
    }
  }

  for(var ingress of json.ingresses) {
    console.log("INGRESS", ingress.metadata.name)
    cy.add({
      data: {
        id: ingress.metadata.uid,
        label: ingress.metadata.name,
        img: 'img/svg/unlabeled/ing.svg'
      }
    })

    for(let lb of ingress.status.loadBalancer.ingress) {
      cy.add({
        data: {
          id: lb.ip,
          label: lb.ip,
          img: 'img/svg/unlabeled/ep.svg'
        }
      })
      cy.add({
        data: {
          id: ingress.metadata.uid + '-link-ip-'+lb.ip, source: ingress.metadata.uid, target: lb.ip
        }
      })
    }

    for(let rule of ingress.spec.rules) {
      if(!rule.http.paths) continue
      for(let path of rule.http.paths) {
        let serviceName = path.backend.serviceName
        cy.add({
          data: {
            id: ingress.metadata.uid + '-link-svc-'+serviceName, source: ingress.metadata.uid, target: serviceName
          }
        })
      }
    }
  }


  reLayout()
});


function reLayout() {
  cy.style().selector('node').style({
    'background-opacity': 0,
    'label': 'data(label)',
    'background-fit': 'cover',
    'background-image': 'data(img)',
    'background-width': '95%',
    'background-height': '95%',
    'shape': 'roundrectangle',
    'width': '128',
    'height': '128',
    'border-width': '0',
    'font-size': '15vh',
    'color': '#eee',
    'text-valign': 'bottom',
    'text-margin-y': '10vh',
    'font-size': '20%',
    'text-outline-color': '#111',
    'text-outline-width': '4'
  });
  cy.style().selector('node:selected').style({
    'border-width': '4',
    'border-color': 'rgb(0,120,215)'
  });

  cy.style().selector('edge').style({
    'target-arrow-shape': 'triangle',
    'curve-style': 'bezier',
    'width': 6,
    'line-color': '#777',
    'arrow-scale': '1.5',
    'target-arrow-color': '#777'
  });

  cy.style().update()
  cy.resize();
  cy.layout({name: 'breadthfirst'}).run();
  cy.fit();
}

</script>
</body>
</html>